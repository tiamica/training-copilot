<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GTA Game</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #111;
            color: #fff;
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* Add new styles for settings menu */
        .settings-menu {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95);
            z-index: 10000;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        .settings-content {
            background-color: #222;
            padding: 30px;
            border-radius: 10px;
            width: 80%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            border: 3px solid #3498db;
        }
        
        .settings-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #444;
        }
        
        .settings-tab {
            padding: 10px 20px;
            background: none;
            border: none;
            color: #aaa;
            font-size: 16px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            margin-right: 10px;
        }
        
        .settings-tab.active {
            color: #3498db;
            border-bottom-color: #3498db;
        }
        
        .settings-panel {
            display: none;
        }
        
        .settings-panel.active {
            display: block;
        }
        
        .settings-group {
            margin-bottom: 25px;
        }
        
        .settings-group h3 {
            color: #3498db;
            margin-bottom: 15px;
            font-size: 18px;
        }
        
        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            background-color: rgba(51, 51, 51, 0.5);
            border-radius: 5px;
        }
        
        .slider-container {
            width: 200px;
        }
        
        .slider-container input {
            width: 100%;
        }
        
        .checkbox-container {
            display: flex;
            align-items: center;
        }
        
        .checkbox-container input {
            margin-right: 10px;
            width: 18px;
            height: 18px;
        }
        
        .key-binding {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 8px;
            background-color: rgba(42, 42, 42, 0.8);
            border-radius: 5px;
        }
        
        .key-binding button {
            background-color: #444;
            color: white;
            border: 1px solid #666;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            min-width: 80px;
        }
        
        .key-binding button:hover {
            background-color: #555;
        }
        
        .key-binding button.rebinding {
            background-color: #e74c3c;
        }
        
        .mission-ui {
            position: absolute;
            top: 20px;
            left: 20px;
            background-color: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 8px;
            border-left: 5px solid #2ecc71;
            z-index: 100;
            display: none;
        }
        
        .mission-title {
            font-size: 18px;
            font-weight: bold;
            color: #2ecc71;
            margin-bottom: 5px;
        }
        
        .mission-description {
            margin-bottom: 10px;
            color: #ddd;
        }
        
        .mission-progress {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        
        .mission-progress-bar {
            width: 200px;
            height: 10px;
            background-color: #333;
            border-radius: 5px;
            overflow: hidden;
            margin-right: 10px;
        }
        
        .mission-progress-fill {
            height: 100%;
            background-color: #2ecc71;
            transition: width 0.3s;
        }
        
        .mission-reward {
            color: #f1c40f;
            font-size: 14px;
        }
        
        /* Update existing styles */
        .header {
            background-color: #222;
            padding: 15px;
            text-align: center;
            border-bottom: 3px solid #e74c3c;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
            position: relative;
        }
        
        .header h1 {
            color: #e74c3c;
            font-size: 28px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }
        
        .header-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .settings-button {
            background-color: #444;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .settings-button:hover {
            background-color: #555;
        }
        
        .game-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        
        /* Rest of existing styles remain the same... */
        
        /* Add sound indicator */
        .sound-indicator {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background-color: rgba(0, 0, 0, 0.8);
            padding: 10px 15px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 10;
            border: 2px solid #444;
            display: none;
        }
        
        /* Mission complete notification */
        .mission-complete {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(46, 204, 113, 0.95);
            color: white;
            padding: 20px 30px;
            border-radius: 10px;
            font-size: 24px;
            font-weight: bold;
            z-index: 10000;
            display: none;
            text-align: center;
            box-shadow: 0 0 20px rgba(46, 204, 113, 0.5);
        }
    </style>
</head>
<body>
    <!-- Settings Menu -->
    <div class="settings-menu" id="settingsMenu">
        <div class="settings-content">
            <div class="settings-tabs">
                <button class="settings-tab active" data-tab="graphics">Graphics</button>
                <button class="settings-tab" data-tab="controls">Controls</button>
                <button class="settings-tab" data-tab="audio">Audio</button>
            </div>
            
            <div class="settings-panel active" id="graphicsPanel">
                <div class="settings-group">
                    <h3>Quality Settings</h3>
                    <div class="setting-item">
                        <span>Graphics Quality</span>
                        <div class="slider-container">
                            <input type="range" min="1" max="3" value="2" class="quality-slider" id="graphicsQuality">
                            <div style="display: flex; justify-content: space-between; font-size: 12px;">
                                <span>Low</span>
                                <span>Medium</span>
                                <span>High</span>
                            </div>
                        </div>
                    </div>
                    <div class="setting-item">
                        <span>Shadows</span>
                        <div class="checkbox-container">
                            <input type="checkbox" id="shadowsEnabled" checked>
                        </div>
                    </div>
                    <div class="setting-item">
                        <span>Anti-aliasing</span>
                        <div class="checkbox-container">
                            <input type="checkbox" id="antiAliasingEnabled" checked>
                        </div>
                    </div>
                </div>
                
                <div class="settings-group">
                    <h3>View Distance</h3>
                    <div class="setting-item">
                        <span>Draw Distance</span>
                        <div class="slider-container">
                            <input type="range" min="500" max="5000" value="2000" step="100" id="drawDistance">
                            <div style="font-size: 12px; text-align: center; margin-top: 5px;">
                                <span id="drawDistanceValue">2000m</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="settings-panel" id="controlsPanel">
                <div class="settings-group">
                    <h3>Key Bindings</h3>
                    <div class="key-binding">
                        <span>Move Forward</span>
                        <button class="key-bind" data-action="forward">W</button>
                    </div>
                    <div class="key-binding">
                        <span>Move Backward</span>
                        <button class="key-bind" data-action="backward">S</button>
                    </div>
                    <div class="key-binding">
                        <span>Strafe Left</span>
                        <button class="key-bind" data-action="left">A</button>
                    </div>
                    <div class="key-binding">
                        <span>Strafe Right</span>
                        <button class="key-bind" data-action="right">D</button>
                    </div>
                    <div class="key-binding">
                        <span>Jump/Shoot</span>
                        <button class="key-bind" data-action="jump">SPACE</button>
                    </div>
                    <div class="key-binding">
                        <span>Enter/Exit Vehicle</span>
                        <button class="key-bind" data-action="enterVehicle">F</button>
                    </div>
                    <div class="key-binding">
                        <span>Run/Accelerate</span>
                        <button class="key-bind" data-action="run">SHIFT</button>
                    </div>
                    <div class="key-binding">
                        <span>Toggle Camera</span>
                        <button class="key-bind" data-action="toggleCamera">C</button>
                    </div>
                    <div class="key-binding">
                        <span>Reload Weapon</span>
                        <button class="key-bind" data-action="reload">R</button>
                    </div>
                    <div style="margin-top: 20px; padding: 10px; background-color: rgba(231, 76, 60, 0.2); border-radius: 5px;">
                        <p style="color: #e74c3c; font-size: 14px;">
                            <i class="fas fa-info-circle"></i> Click a key binding to change it. Press ESC to cancel.
                        </p>
                    </div>
                </div>
                
                <div class="settings-group">
                    <h3>Mouse Sensitivity</h3>
                    <div class="setting-item">
                        <span>First Person Sensitivity</span>
                        <div class="slider-container">
                            <input type="range" min="1" max="10" value="5" id="mouseSensitivity">
                            <div style="font-size: 12px; text-align: center; margin-top: 5px;">
                                <span id="sensitivityValue">Medium</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="settings-panel" id="audioPanel">
                <div class="settings-group">
                    <h3>Volume Levels</h3>
                    <div class="setting-item">
                        <span>Master Volume</span>
                        <div class="slider-container">
                            <input type="range" min="0" max="100" value="80" id="masterVolume">
                            <div style="font-size: 12px; text-align: center; margin-top: 5px;">
                                <span id="masterVolumeValue">80%</span>
                            </div>
                        </div>
                    </div>
                    <div class="setting-item">
                        <span>Effects Volume</span>
                        <div class="slider-container">
                            <input type="range" min="0" max="100" value="90" id="effectsVolume">
                            <div style="font-size: 12px; text-align: center; margin-top: 5px;">
                                <span id="effectsVolumeValue">90%</span>
                            </div>
                        </div>
                    </div>
                    <div class="setting-item">
                        <span>Music Volume</span>
                        <div class="slider-container">
                            <input type="range" min="0" max="100" value="70" id="musicVolume">
                            <div style="font-size: 12px; text-align: center; margin-top: 5px;">
                                <span id="musicVolumeValue">70%</span>
                            </div>
                        </div>
                    </div>
                    <div class="setting-item">
                        <span>Vehicle Sounds</span>
                        <div class="slider-container">
                            <input type="range" min="0" max="100" value="85" id="vehicleVolume">
                            <div style="font-size: 12px; text-align: center; margin-top: 5px;">
                                <span id="vehicleVolumeValue">85%</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="settings-group">
                    <h3>Audio Settings</h3>
                    <div class="setting-item">
                        <span>Enable Sound</span>
                        <div class="checkbox-container">
                            <input type="checkbox" id="soundEnabled" checked>
                        </div>
                    </div>
                    <div class="setting-item">
                        <span>Enable Music</span>
                        <div class="checkbox-container">
                            <input type="checkbox" id="musicEnabled" checked>
                        </div>
                    </div>
                </div>
            </div>
            
            <div style="display: flex; justify-content: space-between; margin-top: 30px;">
                <button id="resetSettings" class="settings-button" style="background-color: #e74c3c;">
                    <i class="fas fa-redo"></i> Reset to Defaults
                </button>
                <button id="closeSettings" class="settings-button" style="background-color: #2ecc71;">
                    <i class="fas fa-check"></i> Apply & Close
                </button>
            </div>
        </div>
    </div>
    
    <!-- Mission UI -->
    <div class="mission-ui" id="missionUI">
        <div class="mission-title" id="missionTitle">MISSION: COLLECT CASH</div>
        <div class="mission-description" id="missionDescription">
            Collect money bags scattered around the city. Avoid police attention!
        </div>
        <div class="mission-progress">
            <div class="mission-progress-bar">
                <div class="mission-progress-fill" id="missionProgressFill" style="width: 0%"></div>
            </div>
            <span id="missionProgressText">0/10</span>
        </div>
        <div class="mission-reward" id="missionReward">Reward: $5000</div>
    </div>
    
    <!-- Mission Complete Notification -->
    <div class="mission-complete" id="missionComplete">
        <div style="font-size: 32px; margin-bottom: 10px;">MISSION COMPLETE!</div>
        <div id="missionCompleteReward">+$5000</div>
        <div style="font-size: 16px; margin-top: 20px;">Press F to start next mission</div>
    </div>
    
    <!-- Sound Indicator -->
    <div class="sound-indicator" id="soundIndicator">
        <i class="fas fa-volume-up"></i>
        <span id="soundIndicatorText">Sound System Active</span>
    </div>
    
    <!-- Loading screen and other existing elements remain... -->
    <div class="loading-screen" id="loadingScreen">
        <h1 style="color: #e74c3c; font-size: 36px; margin-bottom: 20px;"><i class="fas fa-car-crash"></i> CITY CHASE 3D</h1>
        <div class="loading-text" id="loadingText">Generating Massive 3D City...</div>
        <div class="loading-bar">
            <div class="loading-progress" id="loadingProgress"></div>
        </div>
    </div>
    
    <div class="header">
        <h1><i class="fas fa-car-crash"></i> CITY CHASE 3D</h1>
        <div class="header-controls">
            <div class="wanted-level">
                <span style="margin-right: 10px; color: #e74c3c; font-weight: bold;">WANTED LEVEL:</span>
                <div class="wanted-stars" id="wantedStars">
                    <!-- Stars will be added by JavaScript -->
                </div>
            </div>
            <button class="settings-button" id="openSettings">
                <i class="fas fa-cog"></i> Settings
            </button>
        </div>
    </div>
    
    <!-- Rest of your existing HTML structure remains the same... -->
    
<script>
// ============================================
// NEW SOUND SYSTEM
// ============================================
class SoundManager {
    constructor() {
        this.audioContext = null;
        this.sounds = new Map();
        this.music = null;
        this.musicSource = null;
        this.settings = {
            masterVolume: 0.8,
            effectsVolume: 0.9,
            musicVolume: 0.7,
            vehicleVolume: 0.85,
            enabled: true,
            musicEnabled: true
        };
        this.vehicleEngineSources = new Map();
        this.init();
    }
    
    init() {
        try {
            this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
            this.loadSounds();
            this.showIndicator("Sound system initialized");
        } catch (e) {
            console.warn("Web Audio API not supported:", e);
            this.settings.enabled = false;
        }
    }
    
    loadSounds() {
        // Define sound URLs (using online sound effects)
        const soundUrls = {
            shoot: 'https://assets.mixkit.co/sfx/preview/mixkit-gun-shots-1661.mp3',
            collect: 'https://assets.mixkit.co/sfx/preview/mixkit-coin-win-notification-1998.mp3',
            engine: 'https://assets.mixkit.co/sfx/preview/mixkit-car-engine-start-1091.mp3',
            siren: 'https://assets.mixkit.co/sfx/preview/mixkit-police-siren-loop-1005.mp3',
            jump: 'https://assets.mixkit.co/sfx/preview/mixkit-jump-arcade-game-166.mp3',
            hit: 'https://assets.mixkit.co/sfx/preview/mixkit-body-impact-falling-2200.mp3',
            missionComplete: 'https://assets.mixkit.co/sfx/preview/mixkit-winning-chimes-2015.mp3'
        };
        
        // In a real game, you would preload these sounds
        // For now, we'll create placeholder buffers that will be replaced when played
        Object.keys(soundUrls).forEach(key => {
            this.sounds.set(key, { url: soundUrls[key], buffer: null });
        });
    }
    
    playSound(name, options = {}) {
        if (!this.settings.enabled || !this.audioContext) return;
        
        const sound = this.sounds.get(name);
        if (!sound) {
            console.warn(`Sound not found: ${name}`);
            return;
        }
        
        // Create source
        const source = this.audioContext.createBufferSource();
        const gainNode = this.audioContext.createGain();
        
        // Set volume based on sound type
        let volume = this.settings.effectsVolume;
        if (name === 'engine') volume = this.settings.vehicleVolume;
        
        gainNode.gain.value = volume * this.settings.masterVolume * (options.volume || 1);
        
        // Connect nodes
        source.connect(gainNode);
        gainNode.connect(this.audioContext.destination);
        
        // Handle buffer loading
        if (sound.buffer) {
            source.buffer = sound.buffer;
            source.start();
        } else {
            // Load buffer if not cached
            fetch(sound.url)
                .then(response => response.arrayBuffer())
                .then(data => this.audioContext.decodeAudioData(data))
                .then(buffer => {
                    sound.buffer = buffer;
                    source.buffer = buffer;
                    source.start();
                })
                .catch(err => console.error(`Error loading sound ${name}:`, err));
        }
        
        // Store engine source for continuous playing
        if (name === 'engine' && options.loop) {
            this.vehicleEngineSources.set(options.vehicleId, { source, gainNode });
        }
        
        return { source, gainNode };
    }
    
    playMusic() {
        if (!this.settings.musicEnabled || !this.settings.enabled || !this.audioContext) return;
        
        // Simple background music simulation
        const oscillator = this.audioContext.createOscillator();
        const gainNode = this.audioContext.createGain();
        
        oscillator.type = 'sine';
        oscillator.frequency.value = 220;
        
        gainNode.gain.value = 0.1 * this.settings.musicVolume * this.settings.masterVolume;
        
        oscillator.connect(gainNode);
        gainNode.connect(this.audioContext.destination);
        
        oscillator.start();
        
        // Create a simple melody for background
        setTimeout(() => {
            oscillator.frequency.value = 330;
        }, 1000);
        
        setTimeout(() => {
            oscillator.frequency.value = 440;
        }, 2000);
        
        setTimeout(() => {
            oscillator.frequency.value = 220;
        }, 3000);
        
        // Loop
        setInterval(() => {
            oscillator.frequency.value = 220;
            setTimeout(() => oscillator.frequency.value = 330, 1000);
            setTimeout(() => oscillator.frequency.value = 440, 2000);
        }, 4000);
        
        this.musicSource = oscillator;
    }
    
    updateVehicleEngine(vehicleId, isRunning, speed = 0) {
        if (!this.settings.enabled) return;
        
        const engine = this.vehicleEngineSources.get(vehicleId);
        
        if (isRunning) {
            if (!engine) {
                const sound = this.playSound('engine', { loop: true, volume: 0.5, vehicleId });
                if (sound && sound.gainNode) {
                    sound.gainNode.gain.value = 0.5 * this.settings.vehicleVolume * this.settings.masterVolume;
                }
            } else if (engine.gainNode) {
                // Adjust volume based on speed
                engine.gainNode.gain.value = (0.3 + speed * 0.7) * this.settings.vehicleVolume * this.settings.masterVolume;
            }
        } else if (engine) {
            engine.source.stop();
            this.vehicleEngineSources.delete(vehicleId);
        }
    }
    
    showIndicator(text) {
        const indicator = document.getElementById('soundIndicator');
        const textElement = document.getElementById('soundIndicatorText');
        
        textElement.textContent = text;
        indicator.style.display = 'flex';
        
        setTimeout(() => {
            indicator.style.display = 'none';
        }, 2000);
    }
    
    updateSettings(settings) {
        Object.assign(this.settings, settings);
    }
}

// ============================================
// OBJECT POOLING SYSTEM
// ============================================
class ObjectPool {
    constructor(createFunction, initialSize = 10) {
        this.createFunction = createFunction;
        this.pool = [];
        this.activeObjects = [];
        
        for (let i = 0; i < initialSize; i++) {
            this.pool.push(this.createFunction());
        }
    }
    
    get() {
        let obj;
        if (this.pool.length > 0) {
            obj = this.pool.pop();
        } else {
            obj = this.createFunction();
        }
        
        this.activeObjects.push(obj);
        return obj;
    }
    
    release(obj) {
        const index = this.activeObjects.indexOf(obj);
        if (index > -1) {
            this.activeObjects.splice(index, 1);
            this.pool.push(obj);
            
            // Reset object properties
            if (obj.position) obj.position.set(0, 0, 0);
            if (obj.visible !== undefined) obj.visible = false;
        }
    }
    
    update() {
        // Clean up objects that are far away
        for (let i = this.activeObjects.length - 1; i >= 0; i--) {
            const obj = this.activeObjects[i];
            if (obj.userData && obj.userData.life <= 0) {
                this.release(obj);
            }
        }
    }
}

// ============================================
// MISSION SYSTEM
// ============================================
class MissionSystem {
    constructor() {
        this.currentMission = null;
        this.missions = [
            {
                id: 1,
                title: "Collect Cash",
                description: "Collect 10 money bags scattered around the city.",
                type: "collect",
                target: 10,
                progress: 0,
                reward: 5000,
                active: true
            },
            {
                id: 2,
                title: "Escape Police",
                description: "Reach wanted level 3 and then escape the police.",
                type: "escape",
                targetWantedLevel: 3,
                progress: 0,
                reward: 8000,
                active: false
            },
            {
                id: 3,
                title: "Vehicle Collection",
                description: "Enter 5 different types of vehicles.",
                type: "vehicle",
                target: 5,
                progress: 0,
                vehicleTypes: new Set(),
                reward: 3000,
                active: false
            }
        ];
    }
    
    startMission(missionId) {
        this.currentMission = this.missions[missionId - 1];
        this.currentMission.active = true;
        this.currentMission.progress = 0;
        
        if (this.currentMission.type === 'vehicle') {
            this.currentMission.vehicleTypes = new Set();
        }
        
        this.updateUI();
        this.showMissionStart();
    }
    
    completeMission() {
        if (!this.currentMission || !this.currentMission.active) return;
        
        const reward = this.currentMission.reward;
        gameState.player.money += reward;
        
        // Play completion sound
        if (soundManager) {
            soundManager.playSound('missionComplete');
        }
        
        this.showMissionComplete(reward);
        this.currentMission.active = false;
        
        // Start next mission
        const nextMissionId = this.currentMission.id;
        if (nextMissionId < this.missions.length) {
            setTimeout(() => {
                this.startMission(nextMissionId + 1);
            }, 3000);
        }
    }
    
    updateCollectProgress() {
        if (!this.currentMission || !this.currentMission.active) return;
        
        if (this.currentMission.type === 'collect') {
            this.currentMission.progress++;
            
            if (this.currentMission.progress >= this.currentMission.target) {
                this.completeMission();
            } else {
                this.updateUI();
            }
        }
    }
    
    updateEscapeProgress(wantedLevel) {
        if (!this.currentMission || !this.currentMission.active) return;
        
        if (this.currentMission.type === 'escape') {
            if (wantedLevel >= this.currentMission.targetWantedLevel) {
                this.currentMission.progress = 1;
            }
            
            if (wantedLevel === 0 && this.currentMission.progress === 1) {
                this.completeMission();
            }
        }
    }
    
    updateVehicleProgress(vehicleType) {
        if (!this.currentMission || !this.currentMission.active) return;
        
        if (this.currentMission.type === 'vehicle') {
            this.currentMission.vehicleTypes.add(vehicleType);
            this.currentMission.progress = this.currentMission.vehicleTypes.size;
            
            if (this.currentMission.progress >= this.currentMission.target) {
                this.completeMission();
            } else {
                this.updateUI();
            }
        }
    }
    
    updateUI() {
        if (!this.currentMission || !this.currentMission.active) {
            document.getElementById('missionUI').style.display = 'none';
            return;
        }
        
        const ui = document.getElementById('missionUI');
        ui.style.display = 'block';
        
        document.getElementById('missionTitle').textContent = `MISSION: ${this.currentMission.title}`;
        document.getElementById('missionDescription').textContent = this.currentMission.description;
        document.getElementById('missionReward').textContent = `Reward: $${this.currentMission.reward}`;
        
        let progressText = '';
        let progressPercent = 0;
        
        switch(this.currentMission.type) {
            case 'collect':
                progressText = `${this.currentMission.progress}/${this.currentMission.target}`;
                progressPercent = (this.currentMission.progress / this.currentMission.target) * 100;
                break;
            case 'escape':
                progressText = gameState.wantedLevel > 0 ? `Wanted: ${gameState.wantedLevel} stars` : 'Escape!';
                progressPercent = this.currentMission.progress * 100;
                break;
            case 'vehicle':
                progressText = `${this.currentMission.progress}/${this.currentMission.target}`;
                progressPercent = (this.currentMission.progress / this.currentMission.target) * 100;
                break;
        }
        
        document.getElementById('missionProgressText').textContent = progressText;
        document.getElementById('missionProgressFill').style.width = `${progressPercent}%`;
    }
    
    showMissionStart() {
        showNotification(`Mission Started: ${this.currentMission.title}`);
    }
    
    showMissionComplete(reward) {
        const completeUI = document.getElementById('missionComplete');
        document.getElementById('missionCompleteReward').textContent = `+$${reward}`;
        completeUI.style.display = 'block';
        
        setTimeout(() => {
            completeUI.style.display = 'none';
        }, 3000);
    }
}

// ============================================
// SETTINGS SYSTEM
// ============================================
class SettingsManager {
    constructor() {
        this.settings = {
            controls: {
                forward: 'KeyW',
                backward: 'KeyS',
                left: 'KeyA',
                right: 'KeyD',
                jump: 'Space',
                enterVehicle: 'KeyF',
                run: 'ShiftLeft',
                toggleCamera: 'KeyC',
                reload: 'KeyR'
            },
            graphics: {
                quality: 2,
                shadows: true,
                antiAliasing: true,
                drawDistance: 2000
            },
            audio: {
                masterVolume: 80,
                effectsVolume: 90,
                musicVolume: 70,
                vehicleVolume: 85,
                soundEnabled: true,
                musicEnabled: true
            },
            mouseSensitivity: 5
        };
        
        this.currentlyRebinding = null;
        this.loadFromStorage();
    }
    
    loadFromStorage() {
        const saved = localStorage.getItem('cityChaseSettings');
        if (saved) {
            try {
                const parsed = JSON.parse(saved);
                Object.assign(this.settings, parsed);
            } catch (e) {
                console.warn('Failed to load settings:', e);
            }
        }
    }
    
    saveToStorage() {
        localStorage.setItem('cityChaseSettings', JSON.stringify(this.settings));
    }
    
    applyGraphicsSettings() {
        if (renderer) {
            renderer.shadowMap.enabled = this.settings.graphics.shadows;
            camera.far = this.settings.graphics.drawDistance;
            camera.updateProjectionMatrix();
        }
    }
    
    applyAudioSettings() {
        if (soundManager) {
            soundManager.updateSettings({
                masterVolume: this.settings.audio.masterVolume / 100,
                effectsVolume: this.settings.audio.effectsVolume / 100,
                musicVolume: this.settings.audio.musicVolume / 100,
                vehicleVolume: this.settings.audio.vehicleVolume / 100,
                enabled: this.settings.audio.soundEnabled,
                musicEnabled: this.settings.audio.musicEnabled
            });
        }
    }
    
    startRebinding(action) {
        this.currentlyRebinding = action;
        
        // Update UI
        document.querySelectorAll('.key-bind').forEach(btn => {
            btn.classList.remove('rebinding');
        });
        
        const button = document.querySelector(`.key-bind[data-action="${action}"]`);
        if (button) {
            button.classList.add('rebinding');
            button.textContent = 'Press any key...';
        }
        
        showNotification(`Press a key for ${action}... (ESC to cancel)`);
    }
    
    setKeyBinding(action, keyCode) {
        this.settings.controls[action] = keyCode;
        this.saveToStorage();
        this.updateControlDisplay();
    }
    
    updateControlDisplay() {
        Object.keys(this.settings.controls).forEach(action => {
            const button = document.querySelector(`.key-bind[data-action="${action}"]`);
            if (button) {
                const keyCode = this.settings.controls[action];
                button.textContent = this.keyCodeToDisplay(keyCode);
            }
        });
    }
    
    keyCodeToDisplay(keyCode) {
        const keyMap = {
            'KeyW': 'W',
            'KeyS': 'S',
            'KeyA': 'A',
            'KeyD': 'D',
            'Space': 'SPACE',
            'KeyF': 'F',
            'ShiftLeft': 'SHIFT',
            'ShiftRight': 'SHIFT',
            'KeyC': 'C',
            'KeyR': 'R',
            'ArrowUp': '↑',
            'ArrowDown': '↓',
            'ArrowLeft': '←',
            'ArrowRight': '→'
        };
        
        return keyMap[keyCode] || keyCode.replace('Key', '').replace('Arrow', '');
    }
    
    resetToDefaults() {
        this.settings = {
            controls: {
                forward: 'KeyW',
                backward: 'KeyS',
                left: 'KeyA',
                right: 'KeyD',
                jump: 'Space',
                enterVehicle: 'KeyF',
                run: 'ShiftLeft',
                toggleCamera: 'KeyC',
                reload: 'KeyR'
            },
            graphics: {
                quality: 2,
                shadows: true,
                antiAliasing: true,
                drawDistance: 2000
            },
            audio: {
                masterVolume: 80,
                effectsVolume: 90,
                musicVolume: 70,
                vehicleVolume: 85,
                soundEnabled: true,
                musicEnabled: true
            },
            mouseSensitivity: 5
        };
        
        this.saveToStorage();
        this.applyAllSettings();
        this.updateUI();
    }
    
    applyAllSettings() {
        this.applyGraphicsSettings();
        this.applyAudioSettings();
        this.updateControlDisplay();
    }
    
    updateUI() {
        // Update sliders and checkboxes
        document.getElementById('graphicsQuality').value = this.settings.graphics.quality;
        document.getElementById('shadowsEnabled').checked = this.settings.graphics.shadows;
        document.getElementById('antiAliasingEnabled').checked = this.settings.graphics.antiAliasing;
        document.getElementById('drawDistance').value = this.settings.graphics.drawDistance;
        document.getElementById('drawDistanceValue').textContent = `${this.settings.graphics.drawDistance}m`;
        
        document.getElementById('masterVolume').value = this.settings.audio.masterVolume;
        document.getElementById('masterVolumeValue').textContent = `${this.settings.audio.masterVolume}%`;
        document.getElementById('effectsVolume').value = this.settings.audio.effectsVolume;
        document.getElementById('effectsVolumeValue').textContent = `${this.settings.audio.effectsVolume}%`;
        document.getElementById('musicVolume').value = this.settings.audio.musicVolume;
        document.getElementById('musicVolumeValue').textContent = `${this.settings.audio.musicVolume}%`;
        document.getElementById('vehicleVolume').value = this.settings.audio.vehicleVolume;
        document.getElementById('vehicleVolumeValue').textContent = `${this.settings.audio.vehicleVolume}%`;
        document.getElementById('soundEnabled').checked = this.settings.audio.soundEnabled;
        document.getElementById('musicEnabled').checked = this.settings.audio.musicEnabled;
        
        document.getElementById('mouseSensitivity').value = this.settings.mouseSensitivity;
        const sensitivityLabels = ['Very Low', 'Low', 'Medium', 'High', 'Very High'];
        document.getElementById('sensitivityValue').textContent = sensitivityLabels[Math.min(this.settings.mouseSensitivity - 1, 4)] || 'Medium';
        
        this.updateControlDisplay();
    }
}

// ============================================
// INTEGRATE NEW SYSTEMS INTO GAME
// ============================================

// Initialize systems
let soundManager = null;
let bulletPool = null;
let npcPool = null;
let missionSystem = null;
let settingsManager = null;

// Game variables (existing ones)
let scene, camera, renderer;
let player, playerModel, playerVelocity = new THREE.Vector3();
let keys = {};
let clock = new THREE.Clock();

// Initialize the game with new systems
function init() {
    // Initialize new systems
    soundManager = new SoundManager();
    settingsManager = new SettingsManager();
    missionSystem = new MissionSystem();
    
    // Initialize object pools
    bulletPool = new ObjectPool(createBullet, 20);
    npcPool = new ObjectPool(() => createNPC('pedestrian'), 30);
    
    // Create scene (existing code)
    scene = new THREE.Scene();
    scene.fog = new THREE.Fog(0x87CEEB, 50, 2000);
    
    // Create camera (existing code)
    camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 5000);
    
    // Create renderer (existing code)
    renderer = new THREE.WebGLRenderer({ antialias: true });
    updateRendererSize();
    renderer.shadowMap.enabled = true;
    renderer.shadowMap.type = THREE.PCFSoftShadowMap;
    document.getElementById('gameCanvas').appendChild(renderer.domElement);
    
    // Apply settings
    settingsManager.applyAllSettings();
    
    // Set up event listeners for settings
    setupSettingsListeners();
    
    // Create player (existing code)
    createPlayer();
    updateLoadingProgress(10, "Creating player...");
    
    // Generate city (existing code)
    generateCity();
    updateLoadingProgress(30, "Generating massive city...");
    
    // Generate NPCs using pool
    generateNPCs();
    updateLoadingProgress(50, "Creating NPCs...");
    
    // Generate vehicles (existing code)
    generateVehicles();
    updateLoadingProgress(70, "Creating vehicles...");
    
    // Generate collectibles (existing code)
    generateCollectibles();
    updateLoadingProgress(80, "Placing collectibles...");
    
    // Set up camera (existing code)
    setupCamera();
    updateLoadingProgress(90, "Setting up camera...");
    
    // Set up event listeners (existing code + new key binding support)
    setupEventListeners();
    updateLoadingProgress(95, "Finalizing...");
    
    // Start first mission
    setTimeout(() => {
        missionSystem.startMission(1);
    }, 1000);
    
    // Play background music
    if (soundManager) {
        setTimeout(() => {
            soundManager.playMusic();
        }, 2000);
    }
    
    // Update UI (existing code)
    updateUI();
    updateWantedLevel();
    
    // Hide loading screen
    setTimeout(() => {
        document.getElementById('loadingScreen').style.display = 'none';
        showNotification('CONTROLS FIXED: W = Forward, S = Backward, F = Enter Vehicle', 6000);
    }, 500);
    
    // Start game loop
    animate();
}

// ============================================
// MODIFIED FUNCTIONS FOR NEW SYSTEMS
// ============================================

// MODIFIED: Update player movement with new key bindings
function updatePlayer(deltaTime) {
    const controls = settingsManager.settings.controls;
    const speed = (keys[controls.run] || keys['ShiftRight']) ? 0.2 : 0.1;
    
    if (!gameState.player.inVehicle) {
        // Player on foot movement
        const forward = new THREE.Vector3(0, 0, -1);
        forward.applyQuaternion(player.quaternion);
        
        const right = new THREE.Vector3(1, 0, 0);
        right.applyQuaternion(player.quaternion);
        
        // Calculate movement direction using key bindings
        const moveDirection = new THREE.Vector3();
        
        if (keys[controls.forward] || keys['ArrowUp']) {
            moveDirection.add(forward);
        }
        if (keys[controls.backward] || keys['ArrowDown']) {
            moveDirection.sub(forward);
        }
        if (keys[controls.left] || keys['ArrowLeft']) {
            moveDirection.sub(right);
        }
        if (keys[controls.right] || keys['ArrowRight']) {
            moveDirection.add(right);
        }
        
        // Jump with bound key
        if (keys[controls.jump] && gameState.player.isOnGround) {
            playerVelocity.y = jumpForce;
            gameState.player.isOnGround = false;
            
            // Play jump sound
            if (soundManager) {
                soundManager.playSound('jump');
            }
        }
        
        // Normalize if moving diagonally
        if (moveDirection.length() > 0) {
            moveDirection.normalize();
            player.position.addScaledVector(moveDirection, speed);
            
            // Rotate player to face movement direction
            if (keys[controls.forward] || keys[controls.backward]) {
                const targetRotation = Math.atan2(moveDirection.x, moveDirection.z);
                player.rotation.y = THREE.MathUtils.lerp(player.rotation.y, targetRotation, 0.1);
            }
        }
        
        // Apply gravity
        playerVelocity.y += gravity * deltaTime;
        player.position.y += playerVelocity.y * deltaTime;
        
        // Ground collision
        if (player.position.y <= 1) {
            player.position.y = 1;
            playerVelocity.y = 0;
            gameState.player.isOnGround = true;
        }
        
        // Update game state
        gameState.player.x = player.position.x;
        gameState.player.y = player.position.y;
        gameState.player.z = player.position.z;
    } else if (gameState.player.vehicle) {
        // Player in vehicle movement
        const vehicle = gameState.player.vehicle;
        let acceleration = 0;
        let steering = 0;
        
        if (keys[controls.forward] || keys['ArrowUp']) {
            acceleration = vehicle.userData.acceleration;
        }
        if (keys[controls.backward] || keys['ArrowDown']) {
            acceleration = -vehicle.userData.acceleration;
        }
        if (keys[controls.left] || keys['ArrowLeft']) {
            steering = vehicle.userData.turnSpeed;
        }
        if (keys[controls.right] || keys['ArrowRight']) {
            steering = -vehicle.userData.turnSpeed;
        }
        
        // Apply acceleration
        vehicle.userData.speed += acceleration;
        
        // Limit speed
        if (vehicle.userData.speed > vehicle.userData.maxSpeed) {
            vehicle.userData.speed = vehicle.userData.maxSpeed;
        }
        if (vehicle.userData.speed < -vehicle.userData.maxSpeed / 2) {
            vehicle.userData.speed = -vehicle.userData.maxSpeed / 2;
        }
        
        // Apply steering
        const steeringEffect = Math.max(0.1, 1 - Math.abs(vehicle.userData.speed) / vehicle.userData.maxSpeed);
        vehicle.rotation.y += steering * steeringEffect * (vehicle.userData.speed > 0 ? 1 : -1);
        
        // Apply friction when no acceleration
        if (!keys[controls.forward] && !keys[controls.backward] && !keys['ArrowUp'] && !keys['ArrowDown']) {
            vehicle.userData.speed *= 0.97;
        }
        
        // Move vehicle
        const direction = new THREE.Vector3(0, 0, -1);
        direction.applyQuaternion(vehicle.quaternion);
        vehicle.position.addScaledVector(direction, vehicle.userData.speed);
        
        // Update player position
        player.position.copy(vehicle.position);
        player.position.y += 1;
        
        // Rotate player to match vehicle
        player.rotation.y = vehicle.rotation.y;
        
        // Update vehicle engine sound
        if (soundManager) {
            const normalizedSpeed = Math.abs(vehicle.userData.speed) / vehicle.userData.maxSpeed;
            soundManager.updateVehicleEngine('player', true, normalizedSpeed);
        }
    }
}

// MODIFIED: Try to enter a vehicle with new key binding
function tryEnterVehicle() {
    let closestVehicle = null;
    let closestDistance = Infinity;
    
    for (const vehicle of gameState.vehicles) {
        const distance = player.position.distanceTo(vehicle.position);
        if (distance < 5 && distance < closestDistance) {
            closestDistance = distance;
            closestVehicle = vehicle;
        }
    }
    
    if (closestVehicle) {
        // Enter vehicle
        gameState.player.inVehicle = true;
        gameState.player.vehicle = closestVehicle;
        gameState.player.vehicleType = closestVehicle.userData.type;
        
        // Position player in vehicle
        player.position.copy(closestVehicle.position);
        player.position.y += 1;
        
        // Align player rotation with vehicle
        player.rotation.y = closestVehicle.rotation.y;
        
        // Hide player model when in vehicle (for first person)
        playerModel.visible = gameState.player.cameraMode !== 'first';
        
        // Play engine sound
        if (soundManager) {
            soundManager.playSound('engine', { loop: false, volume: 1 });
        }
        
        // Update mission progress
        if (missionSystem) {
            missionSystem.updateVehicleProgress(closestVehicle.userData.type);
        }
        
        showNotification(`Entered ${closestVehicle.userData.type} vehicle!`);
        updateUI();
        return true;
    }
    return false;
}

// MODIFIED: Shoot weapon with sound
function shoot() {
    if (gameState.player.ammo <= 0) return;
    
    gameState.player.ammo--;
    
    // Create bullet from pool
    const bullet = bulletPool.get();
    bullet.visible = true;
    bullet.position.copy(player.position);
    bullet.position.y += 1.6;
    
    // Play shooting sound
    if (soundManager) {
        soundManager.playSound('shoot');
    }
    
    // Increase wanted level when shooting in city
    if (gameState.wantedLevel < 5) {
        gameState.wantedLevel++;
        updateWantedLevel();
        if (gameState.wantedLevel > 0) {
            showNotification(`Wanted level: ${gameState.wantedLevel} star${gameState.wantedLevel > 1 ? 's' : ''}!`);
            
            // Play siren sound at high wanted levels
            if (gameState.wantedLevel >= 3 && soundManager) {
                soundManager.playSound('siren', { volume: 0.7 });
            }
        }
    }
    
    // Update mission progress for escape mission
    if (missionSystem) {
        missionSystem.updateEscapeProgress(gameState.wantedLevel);
    }
    
    updateUI();
    
    // Check if bullet hit anything after delay
    setTimeout(() => checkBulletHits(bullet), 50);
}

// MODIFIED: Create bullet for pool
function createBullet() {
    const bulletGeometry = new THREE.SphereGeometry(0.1, 8, 8);
    const bulletMaterial = new THREE.MeshPhongMaterial({ 
        color: 0xf39c12,
        emissive: 0xf39c12,
        emissiveIntensity: 0.5
    });
    const bullet = new THREE.Mesh(bulletGeometry, bulletMaterial);
    bullet.visible = false;
    
    bullet.userData.velocity = new THREE.Vector3(0, 0, -1);
    bullet.userData.life = 1.5;
    bullet.userData.damage = 25;
    
    return bullet;
}

// MODIFIED: Update bullets using pool
function updateBullets(deltaTime) {
    bulletPool.activeObjects.forEach((bullet, index) => {
        // Move bullet
        const direction = new THREE.Vector3(0, 0, -1);
        direction.applyQuaternion(player.quaternion);
        bullet.position.addScaledVector(direction, deltaTime * 100);
        
        // Decrease life
        bullet.userData.life -= deltaTime;
        
        // Return to pool if life ended
        if (bullet.userData.life <= 0 || bullet.position.length() > 3000) {
            bulletPool.release(bullet);
        }
    });
}

// MODIFIED: Collectibles with sound
function updateCollectibles(deltaTime) {
    gameState.collectibles.forEach((collectible, index) => {
        // Rotate collectible
        collectible.rotation.y += collectible.userData.rotationSpeed;
        
        // Bob up and down
        const time = Date.now() * 0.001;
        collectible.position.y = 0.5 + Math.sin(time + index) * 0.3;
        
        // Check collision with player
        const distance = player.position.distanceTo(collectible.position);
        if (distance < 3) {
            // Collect
            const value = collectible.userData.value;
            gameState.player.money += value;
            scene.remove(collectible);
            gameState.collectibles.splice(index, 1);
            
            // Play collect sound
            if (soundManager) {
                soundManager.playSound('collect');
            }
            
            // Update mission progress
            if (missionSystem) {
                missionSystem.updateCollectProgress();
            }
            
            showNotification(`+$${value}! Total: $${gameState.player.money}`);
            updateUI();
            
            // Create new collectible after delay
            setTimeout(() => {
                const newCollectible = createCollectible();
                newCollectible.position.set(
                    Math.random() * 1800 - 900,
                    0.5,
                    Math.random() * 1800 - 900
                );
                newCollectible.userData.value = 50 + Math.floor(Math.random() * 150);
                newCollectible.userData.type = 'money';
                newCollectible.userData.rotationSpeed = 0.01 + Math.random() * 0.02;
                scene.add(newCollectible);
                gameState.collectibles.push(newCollectible);
            }, 3000);
        }
    });
}

// ============================================
// SETTINGS EVENT LISTENERS
// ============================================
function setupSettingsListeners() {
    // Open settings
    document.getElementById('openSettings').addEventListener('click', () => {
        document.getElementById('settingsMenu').style.display = 'flex';
        settingsManager.updateUI();
    });
    
    // Close settings
    document.getElementById('closeSettings').addEventListener('click', () => {
        document.getElementById('settingsMenu').style.display = 'none';
        settingsManager.saveToStorage();
        settingsManager.applyAllSettings();
    });
    
    // Reset settings
    document.getElementById('resetSettings').addEventListener('click', () => {
        if (confirm('Reset all settings to defaults?')) {
            settingsManager.resetToDefaults();
        }
    });
    
    // Tab switching
    document.querySelectorAll('.settings-tab').forEach(tab => {
        tab.addEventListener('click', () => {
            const tabId = tab.dataset.tab;
            
            // Update active tab
            document.querySelectorAll('.settings-tab').forEach(t => {
                t.classList.remove('active');
            });
            tab.classList.add('active');
            
            // Show active panel
            document.querySelectorAll('.settings-panel').forEach(panel => {
                panel.classList.remove('active');
            });
            document.getElementById(`${tabId}Panel`).classList.add('active');
        });
    });
    
    // Key binding
    document.querySelectorAll('.key-bind').forEach(button => {
        button.addEventListener('click', () => {
            const action = button.dataset.action;
            settingsManager.startRebinding(action);
        });
    });
    
    // Slider updates
    document.getElementById('drawDistance').addEventListener('input', (e) => {
        document.getElementById('drawDistanceValue').textContent = `${e.target.value}m`;
        settingsManager.settings.graphics.drawDistance = parseInt(e.target.value);
    });
    
    document.getElementById('masterVolume').addEventListener('input', (e) => {
        document.getElementById('masterVolumeValue').textContent = `${e.target.value}%`;
        settingsManager.settings.audio.masterVolume = parseInt(e.target.value);
    });
    
    document.getElementById('effectsVolume').addEventListener('input', (e) => {
        document.getElementById('effectsVolumeValue').textContent = `${e.target.value}%`;
        settingsManager.settings.audio.effectsVolume = parseInt(e.target.value);
    });
    
    document.getElementById('musicVolume').addEventListener('input', (e) => {
        document.getElementById('musicVolumeValue').textContent = `${e.target.value}%`;
        settingsManager.settings.audio.musicVolume = parseInt(e.target.value);
    });
    
    document.getElementById('vehicleVolume').addEventListener('input', (e) => {
        document.getElementById('vehicleVolumeValue').textContent = `${e.target.value}%`;
        settingsManager.settings.audio.vehicleVolume = parseInt(e.target.value);
    });
    
    document.getElementById('mouseSensitivity').addEventListener('input', (e) => {
        const sensitivityLabels = ['Very Low', 'Low', 'Medium', 'High', 'Very High'];
        document.getElementById('sensitivityValue').textContent = 
            sensitivityLabels[Math.min(e.target.value - 1, 4)] || 'Medium';
        settingsManager.settings.mouseSensitivity = parseInt(e.target.value);
    });
    
    // Checkbox updates
    document.getElementById('shadowsEnabled').addEventListener('change', (e) => {
        settingsManager.settings.graphics.shadows = e.target.checked;
    });
    
    document.getElementById('antiAliasingEnabled').addEventListener('change', (e) => {
        settingsManager.settings.graphics.antiAliasing = e.target.checked;
    });
    
    document.getElementById('soundEnabled').addEventListener('change', (e) => {
        settingsManager.settings.audio.soundEnabled = e.target.checked;
    });
    
    document.getElementById('musicEnabled').addEventListener('change', (e) => {
        settingsManager.settings.audio.musicEnabled = e.target.checked;
    });
}

// ============================================
// MODIFIED KEYBOARD EVENT LISTENER
// ============================================
function setupEventListeners() {
    // Keyboard events with key binding support
    window.addEventListener('keydown', (e) => {
        // Handle key rebinding
        if (settingsManager.currentlyRebinding) {
            if (e.code === 'Escape') {
                // Cancel rebinding
                settingsManager.currentlyRebinding = null;
                settingsManager.updateControlDisplay();
                showNotification('Key binding cancelled');
            } else {
                // Set new key binding
                settingsManager.setKeyBinding(settingsManager.currentlyRebinding, e.code);
                settingsManager.currentlyRebinding = null;
                showNotification('Key binding saved!');
            }
            e.preventDefault();
            return;
        }
        
        // Regular key handling
        keys[e.code] = true;
        
        // Prevent space bar from scrolling
        if (e.code === 'Space') {
            e.preventDefault();
        }
        
        // Enter/exit vehicle with F key (configurable)
        if (e.code === settingsManager.settings.controls.enterVehicle) {
            if (gameState.player.inVehicle) {
                exitVehicle();
            } else {
                tryEnterVehicle();
            }
        }
        
        // Reload weapon
        if (e.code === settingsManager.settings.controls.reload) {
            gameState.player.ammo = 12;
            updateUI();
            showNotification('Weapon reloaded!');
        }
        
        // Toggle camera
        if (e.code === settingsManager.settings.controls.toggleCamera) {
            toggleCamera();
        }
        
        // Open settings with ESC
        if (e.code === 'Escape') {
            document.getElementById('settingsMenu').style.display = 'flex';
            settingsManager.updateUI();
        }
    });
    
    window.addEventListener('keyup', (e) => {
        keys[e.code] = false;
    });
    
    // Rest of existing event listeners remain...
}

// ============================================
// EXISTING FUNCTIONS (unchanged except where noted)
// ============================================

// All your existing functions remain the same except for the modifications above.
// The rest of your code (createPlayer, generateCity, generateNPCs, generateVehicles, 
// animate loop, etc.) remains unchanged.

// Note: I've shown the key modifications. The complete implementation would include
// all your existing code with these modifications integrated.

// Initialize when DOM is loaded
window.addEventListener('DOMContentLoaded', init);
</script>

<!-- The rest of your existing HTML (game container, sidebar, footer, etc.) remains exactly the same -->
</body>
</html>
