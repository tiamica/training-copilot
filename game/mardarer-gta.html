<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D City Chase - GTA Style Game</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #111;
            color: #fff;
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            background-color: #222;
            padding: 15px;
            text-align: center;
            border-bottom: 3px solid #e74c3c;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
            position: relative;
        }
        
        .header h1 {
            color: #e74c3c;
            font-size: 28px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }
        
        .header h1 i {
            margin-right: 10px;
        }
        
        .game-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        
        #gameCanvas {
            width: 100%;
            height: 100%;
            display: block;
        }
        
        .sidebar {
            width: 300px;
            background-color: rgba(34, 34, 34, 0.9);
            padding: 20px;
            overflow-y: auto;
            border-left: 2px solid #444;
            z-index: 10;
        }
        
        .controls {
            background-color: rgba(51, 51, 51, 0.9);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .controls h2 {
            color: #3498db;
            margin-bottom: 15px;
            font-size: 20px;
            display: flex;
            align-items: center;
        }
        
        .controls h2 i {
            margin-right: 10px;
        }
        
        .control-group {
            display: flex;
            margin-bottom: 10px;
            padding: 8px;
            background-color: rgba(42, 42, 42, 0.8);
            border-radius: 5px;
        }
        
        .key {
            display: inline-block;
            background-color: #444;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            margin-right: 10px;
            min-width: 40px;
            text-align: center;
            font-weight: bold;
            border: 1px solid #666;
        }
        
        .control-description {
            display: flex;
            align-items: center;
        }
        
        .stats {
            background-color: rgba(51, 51, 51, 0.9);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .stats h2 {
            color: #2ecc71;
            margin-bottom: 15px;
            font-size: 20px;
            display: flex;
            align-items: center;
        }
        
        .stats h2 i {
            margin-right: 10px;
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(68, 68, 68, 0.5);
        }
        
        .health-bar {
            height: 20px;
            width: 100%;
            background-color: #333;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 5px;
        }
        
        .health-fill {
            height: 100%;
            background-color: #2ecc71;
            width: 100%;
            transition: width 0.3s;
        }
        
        .vehicle-list {
            background-color: rgba(51, 51, 51, 0.9);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .vehicle-list h2 {
            color: #f39c12;
            margin-bottom: 15px;
            font-size: 20px;
            display: flex;
            align-items: center;
        }
        
        .vehicle-list h2 i {
            margin-right: 10px;
        }
        
        .instructions {
            background-color: rgba(51, 51, 51, 0.9);
            padding: 15px;
            border-radius: 8px;
            font-size: 14px;
            line-height: 1.5;
        }
        
        .instructions h2 {
            color: #9b59b6;
            margin-bottom: 10px;
            font-size: 20px;
            display: flex;
            align-items: center;
        }
        
        .instructions h2 i {
            margin-right: 10px;
        }
        
        .instructions ul {
            padding-left: 20px;
        }
        
        .instructions li {
            margin-bottom: 8px;
        }
        
        .footer {
            background-color: #222;
            padding: 10px;
            text-align: center;
            border-top: 2px solid #444;
            font-size: 14px;
            color: #aaa;
            z-index: 100;
            position: relative;
        }
        
        .footer a {
            color: #3498db;
            text-decoration: none;
        }
        
        .footer a:hover {
            text-decoration: underline;
        }
        
        .wanted-level {
            display: flex;
            align-items: center;
            background-color: rgba(34, 34, 34, 0.8);
            padding: 8px 15px;
            border-radius: 20px;
            border: 2px solid #c0392b;
        }
        
        .wanted-stars {
            display: flex;
        }
        
        .wanted-star {
            color: #f1c40f;
            margin-right: 5px;
            font-size: 20px;
        }
        
        .wanted-star.empty {
            color: #555;
        }
        
        .notification {
            position: fixed;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            border-left: 5px solid #e74c3c;
            z-index: 1000;
            display: none;
        }
        
        .weapon-display {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 10px 15px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            z-index: 10;
        }
        
        .weapon-icon {
            font-size: 24px;
            margin-right: 10px;
            color: #f39c12;
        }
        
        .weapon-name {
            font-size: 18px;
            font-weight: bold;
        }
        
        .ammo-count {
            margin-left: 15px;
            color: #e74c3c;
            font-weight: bold;
        }
        
        .mini-map {
            position: absolute;
            top: 100px;
            right: 20px;
            background-color: rgba(0, 0, 0, 0.7);
            border: 2px solid #3498db;
            border-radius: 8px;
            width: 150px;
            height: 150px;
            overflow: hidden;
            z-index: 10;
        }
        
        .camera-toggle {
            position: absolute;
            top: 100px;
            left: 20px;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 10px 15px;
            border-radius: 8px;
            z-index: 10;
            cursor: pointer;
        }
        
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #111;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }
        
        .loading-bar {
            width: 300px;
            height: 20px;
            background-color: #333;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 20px;
        }
        
        .loading-progress {
            height: 100%;
            background-color: #e74c3c;
            width: 0%;
            transition: width 0.3s;
        }
        
        .loading-text {
            margin-top: 10px;
            font-size: 18px;
            color: #fff;
        }
        
        .vehicle-item {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            padding: 8px;
            background-color: rgba(42, 42, 42, 0.8);
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .vehicle-item:hover {
            background-color: rgba(58, 58, 58, 0.8);
            transform: translateX(5px);
        }
        
        .vehicle-icon {
            width: 30px;
            height: 30px;
            margin-right: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }
        
        @media (max-width: 1200px) {
            .sidebar {
                width: 250px;
            }
        }
        
        @media (max-width: 900px) {
            .game-container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: 300px;
                border-left: none;
                border-top: 2px solid #444;
            }
            
            .mini-map {
                width: 100px;
                height: 100px;
            }
        }
    </style>
</head>
<body>
    <div class="loading-screen" id="loadingScreen">
        <h1 style="color: #e74c3c; font-size: 36px; margin-bottom: 20px;"><i class="fas fa-car-crash"></i> CITY CHASE 3D</h1>
        <div class="loading-text">Generating 3D City...</div>
        <div class="loading-bar">
            <div class="loading-progress" id="loadingProgress"></div>
        </div>
    </div>
    
    <div class="header">
        <h1><i class="fas fa-car-crash"></i> CITY CHASE 3D</h1>
        <div class="wanted-level">
            <span style="margin-right: 10px; color: #e74c3c; font-weight: bold;">WANTED LEVEL:</span>
            <div class="wanted-stars" id="wantedStars">
                <!-- Stars will be added by JavaScript -->
            </div>
        </div>
    </div>
    
    <div class="game-container">
        <div id="gameCanvas"></div>
        
        <div class="sidebar">
            <div class="controls">
                <h2><i class="fas fa-gamepad"></i> CONTROLS</h2>
                <div class="control-group">
                    <div class="key">W</div>
                    <div class="control-description">Move Forward</div>
                </div>
                <div class="control-group">
                    <div class="key">A</div>
                    <div class="control-description">Move Left</div>
                </div>
                <div class="control-group">
                    <div class="key">S</div>
                    <div class="control-description">Move Backward</div>
                </div>
                <div class="control-group">
                    <div class="key">D</div>
                    <div class="control-description">Move Right</div>
                </div>
                <div class="control-group">
                    <div class="key">SPACE</div>
                    <div class="control-description">Shoot / Jump</div>
                </div>
                <div class="control-group">
                    <div class="key">R-CLICK</div>
                    <div class="control-description">Shoot</div>
                </div>
                <div class="control-group">
                    <div class="key">E</div>
                    <div class="control-description">Enter/Exit Vehicle</div>
                </div>
                <div class="control-group">
                    <div class="key">SHIFT</div>
                    <div class="control-description">Run / Accelerate</div>
                </div>
                <div class="control-group">
                    <div class="key">C</div>
                    <div class="control-description">Toggle Camera</div>
                </div>
                <div class="control-group">
                    <div class="key">R</div>
                    <div class="control-description">Reload Weapon</div>
                </div>
            </div>
            
            <div class="stats">
                <h2><i class="fas fa-chart-line"></i> STATS</h2>
                <div class="stat-item">
                    <span>Health:</span>
                    <span id="healthValue">100%</span>
                </div>
                <div class="health-bar">
                    <div class="health-fill" id="healthBar"></div>
                </div>
                <div class="stat-item">
                    <span>Money:</span>
                    <span id="moneyValue">$500</span>
                </div>
                <div class="stat-item">
                    <span>Weapon:</span>
                    <span id="weaponValue">Pistol</span>
                </div>
                <div class="stat-item">
                    <span>Vehicle:</span>
                    <span id="vehicleValue">On Foot</span>
                </div>
                <div class="stat-item">
                    <span>Police Alert:</span>
                    <span id="policeValue">None</span>
                </div>
            </div>
            
            <div class="vehicle-list">
                <h2><i class="fas fa-car"></i> VEHICLES</h2>
                <div class="vehicle-item" id="playerCar">
                    <div class="vehicle-icon">
                        <i class="fas fa-car" style="color: #e74c3c;"></i>
                    </div>
                    <div>Player's Car (Red)</div>
                </div>
                <div class="vehicle-item" id="policeCar">
                    <div class="vehicle-icon">
                        <i class="fas fa-car" style="color: #3498db;"></i>
                    </div>
                    <div>Police Car (Blue)</div>
                </div>
                <div class="vehicle-item" id="ambulance">
                    <div class="vehicle-icon">
                        <i class="fas fa-ambulance" style="color: #fff;"></i>
                    </div>
                    <div>Ambulance (White)</div>
                </div>
                <div class="vehicle-item" id="bus">
                    <div class="vehicle-icon">
                        <i class="fas fa-bus" style="color: #f39c12;"></i>
                    </div>
                    <div>Bus (Yellow)</div>
                </div>
                <div class="vehicle-item" id="van">
                    <div class="vehicle-icon">
                        <i class="fas fa-truck" style="color: #2ecc71;"></i>
                    </div>
                    <div>Van (Green)</div>
                </div>
            </div>
            
            <div class="instructions">
                <h2><i class="fas fa-info-circle"></i> INSTRUCTIONS</h2>
                <ul>
                    <li>Move with WASD keys</li>
                    <li>Shoot with SPACEBAR or RIGHT MOUSE CLICK</li>
                    <li>Press E to enter/exit vehicles</li>
                    <li>Hold SHIFT to run or accelerate in vehicles</li>
                    <li>Avoid police when you have a wanted level</li>
                    <li>Collect money bags to increase your cash</li>
                    <li>Shoot enemies to reduce your wanted level</li>
                    <li>Press C to toggle between 1st and 3rd person view</li>
                </ul>
            </div>
        </div>
    </div>
    
    <div class="weapon-display" id="weaponDisplay">
        <div class="weapon-icon">
            <i class="fas fa-gun"></i>
        </div>
        <div class="weapon-name">Pistol</div>
        <div class="ammo-count" id="ammoCount">12</div>
    </div>
    
    <div class="camera-toggle" id="cameraToggle">
        Camera: <span id="cameraMode">Third Person</span>
    </div>
    
    <canvas class="mini-map" id="miniMap" width="150" height="150"></canvas>
    
    <div class="notification" id="notification">
        <span id="notificationText">You entered a vehicle!</span>
    </div>
    
    <div class="footer">
        <p>City Chase 3D - A GTA-style 3D game | Created for demonstration purposes | 
        <a href="#" id="resetGame">Reset Game</a> | 
        <a href="#" id="fullscreenToggle">Toggle Fullscreen</a></p>
    </div>

    <script>
        // Game variables
        let scene, camera, renderer;
        let player, playerModel, playerVelocity = new THREE.Vector3();
        let keys = {};
        let clock = new THREE.Clock();
        let mouseX = 0, mouseY = 0;
        let windowHalfX = window.innerWidth / 2;
        let windowHalfY = window.innerHeight / 2;
        
        let gameState = {
            player: {
                x: 0,
                y: 1,
                z: 0,
                health: 100,
                money: 500,
                weapon: 'pistol',
                ammo: 12,
                inVehicle: false,
                vehicleType: null,
                vehicle: null,
                cameraMode: 'third', // 'first' or 'third'
                isOnGround: true,
                cameraAngle: 0,
                cameraHeight: 3
            },
            vehicles: [],
            npcs: [],
            bullets: [],
            buildings: [],
            roads: [],
            collectibles: [],
            explosions: [],
            wantedLevel: 0,
            policeSpawnTimer: 0,
            gameTime: 0,
            lastWantedIncrease: 0
        };
        
        // Physics
        let gravity = -9.8;
        let jumpForce = 5;
        
        // Asset generation progress
        let assetsLoaded = 0;
        let totalAssets = 100;
        
        // Initialize the game
        function init() {
            // Create scene
            scene = new THREE.Scene();
            scene.fog = new THREE.Fog(0x87CEEB, 10, 1000);
            
            // Create camera
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            
            // Create renderer
            renderer = new THREE.WebGLRenderer({ antialias: true });
            updateRendererSize();
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            document.getElementById('gameCanvas').appendChild(renderer.domElement);
            
            // Create lights
            const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(50, 100, 50);
            directionalLight.castShadow = true;
            directionalLight.shadow.mapSize.width = 2048;
            directionalLight.shadow.mapSize.height = 2048;
            directionalLight.shadow.camera.near = 0.5;
            directionalLight.shadow.camera.far = 500;
            directionalLight.shadow.camera.left = -100;
            directionalLight.shadow.camera.right = 100;
            directionalLight.shadow.camera.top = 100;
            directionalLight.shadow.camera.bottom = -100;
            scene.add(directionalLight);
            
            // Create player
            createPlayer();
            updateLoadingProgress(10);
            
            // Generate city
            generateCity();
            updateLoadingProgress(30);
            
            // Generate NPCs
            generateNPCs();
            updateLoadingProgress(50);
            
            // Generate vehicles
            generateVehicles();
            updateLoadingProgress(70);
            
            // Generate collectibles
            generateCollectibles();
            updateLoadingProgress(80);
            
            // Set up camera
            setupCamera();
            updateLoadingProgress(90);
            
            // Set up event listeners
            setupEventListeners();
            updateLoadingProgress(95);
            
            // Update UI
            updateUI();
            updateWantedLevel();
            
            // Hide loading screen
            setTimeout(() => {
                document.getElementById('loadingScreen').style.display = 'none';
                showNotification('Welcome to City Chase 3D! Use WASD to move, SPACE to jump/shoot!', 5000);
            }, 500);
            
            // Start game loop
            animate();
        }
        
        // Update loading progress
        function updateLoadingProgress(percent) {
            document.getElementById('loadingProgress').style.width = `${percent}%`;
            assetsLoaded = percent;
        }
        
        // Create player
        function createPlayer() {
            // Player body
            const bodyGeometry = new THREE.BoxGeometry(0.5, 1, 0.5);
            const bodyMaterial = new THREE.MeshPhongMaterial({ color: 0x3498db });
            const body = new THREE.Mesh(bodyGeometry, bodyMaterial);
            body.castShadow = true;
            
            // Player head
            const headGeometry = new THREE.SphereGeometry(0.3, 16, 16);
            const headMaterial = new THREE.MeshPhongMaterial({ color: 0xfad5a5 });
            const head = new THREE.Mesh(headGeometry, headMaterial);
            head.position.y = 0.8;
            head.castShadow = true;
            
            // Create player group
            player = new THREE.Group();
            player.add(body);
            player.add(head);
            player.position.set(0, 1, 0);
            
            // Player weapon
            const weaponGeometry = new THREE.BoxGeometry(0.1, 0.05, 0.3);
            const weaponMaterial = new THREE.MeshPhongMaterial({ color: 0x333333 });
            const weapon = new THREE.Mesh(weaponGeometry, weaponMaterial);
            weapon.position.set(0.3, 0.5, 0.2);
            player.add(weapon);
            
            scene.add(player);
            playerModel = player;
        }
        
        // Generate city
        function generateCity() {
            // Ground
            const groundGeometry = new THREE.PlaneGeometry(1000, 1000);
            const groundMaterial = new THREE.MeshPhongMaterial({ 
                color: 0x2ecc71,
                side: THREE.DoubleSide
            });
            const ground = new THREE.Mesh(groundGeometry, groundMaterial);
            ground.rotation.x = -Math.PI / 2;
            ground.receiveShadow = true;
            scene.add(ground);
            
            // Roads
            const roadMaterial = new THREE.MeshPhongMaterial({ color: 0x444444 });
            const roadMarkingMaterial = new THREE.MeshPhongMaterial({ color: 0xffffff });
            
            // Create a grid of roads
            for (let i = -400; i <= 400; i += 100) {
                // Horizontal roads
                const roadHGeometry = new THREE.PlaneGeometry(1000, 20);
                const roadH = new THREE.Mesh(roadHGeometry, roadMaterial);
                roadH.position.set(0, 0.01, i);
                roadH.rotation.x = -Math.PI / 2;
                roadH.receiveShadow = true;
                scene.add(roadH);
                
                // Vertical roads
                const roadVGeometry = new THREE.PlaneGeometry(20, 1000);
                const roadV = new THREE.Mesh(roadVGeometry, roadMaterial);
                roadV.position.set(i, 0.01, 0);
                roadV.rotation.x = -Math.PI / 2;
                roadV.receiveShadow = true;
                scene.add(roadV);
            }
            
            // Buildings
            const buildingColors = [0x8B4513, 0xA0522D, 0xD2691E, 0xCD853F, 0xD2B48C];
            
            for (let i = -350; i <= 350; i += 150) {
                for (let j = -350; j <= 350; j += 150) {
                    // Skip roads
                    if (Math.abs(i) % 100 === 0 || Math.abs(j) % 100 === 0) continue;
                    
                    const height = 10 + Math.random() * 30;
                    const width = 20 + Math.random() * 30;
                    const depth = 20 + Math.random() * 30;
                    
                    const buildingGeometry = new THREE.BoxGeometry(width, height, depth);
                    const buildingMaterial = new THREE.MeshPhongMaterial({ 
                        color: buildingColors[Math.floor(Math.random() * buildingColors.length)]
                    });
                    const building = new THREE.Mesh(buildingGeometry, buildingMaterial);
                    building.position.set(i + Math.random() * 50 - 25, height / 2, j + Math.random() * 50 - 25);
                    building.castShadow = true;
                    building.receiveShadow = true;
                    
                    // Add windows
                    const windowGeometry = new THREE.BoxGeometry(width * 0.8, height * 0.6, 0.1);
                    const windowMaterial = new THREE.MeshPhongMaterial({ 
                        color: 0x1E90FF,
                        transparent: true,
                        opacity: 0.7
                    });
                    const windows = new THREE.Mesh(windowGeometry, windowMaterial);
                    windows.position.y = height * 0.1;
                    building.add(windows);
                    
                    scene.add(building);
                    
                    // Store building data
                    gameState.buildings.push({
                        mesh: building,
                        position: building.position,
                        width: width,
                        height: height,
                        depth: depth
                    });
                }
            }
            
            // Add some trees
            for (let i = 0; i < 50; i++) {
                const tree = createTree();
                tree.position.set(
                    Math.random() * 800 - 400,
                    0,
                    Math.random() * 800 - 400
                );
                scene.add(tree);
            }
        }
        
        // Create a tree
        function createTree() {
            const treeGroup = new THREE.Group();
            
            // Trunk
            const trunkGeometry = new THREE.CylinderGeometry(0.3, 0.5, 3, 8);
            const trunkMaterial = new THREE.MeshPhongMaterial({ color: 0x8B4513 });
            const trunk = new THREE.Mesh(trunkGeometry, trunkMaterial);
            trunk.position.y = 1.5;
            trunk.castShadow = true;
            treeGroup.add(trunk);
            
            // Leaves
            const leavesGeometry = new THREE.SphereGeometry(2, 8, 8);
            const leavesMaterial = new THREE.MeshPhongMaterial({ color: 0x228B22 });
            const leaves = new THREE.Mesh(leavesGeometry, leavesMaterial);
            leaves.position.y = 4;
            leaves.castShadow = true;
            treeGroup.add(leaves);
            
            return treeGroup;
        }
        
        // Generate NPCs
        function generateNPCs() {
            for (let i = 0; i < 20; i++) {
                const npc = createNPC();
                npc.position.set(
                    Math.random() * 800 - 400,
                    0.5,
                    Math.random() * 800 - 400
                );
                
                // Random direction
                npc.userData.direction = new THREE.Vector3(
                    Math.random() * 2 - 1,
                    0,
                    Math.random() * 2 - 1
                ).normalize();
                
                npc.userData.speed = 0.5 + Math.random() * 1.5;
                npc.userData.moveTimer = Math.random() * 5;
                npc.userData.type = 'pedestrian';
                
                scene.add(npc);
                gameState.npcs.push(npc);
            }
        }
        
        // Create an NPC
        function createNPC() {
            const npcGroup = new THREE.Group();
            
            // Body
            const bodyGeometry = new THREE.BoxGeometry(0.4, 0.8, 0.4);
            const bodyMaterial = new THREE.MeshPhongMaterial({ 
                color: new THREE.Color().setHSL(Math.random(), 0.7, 0.5)
            });
            const body = new THREE.Mesh(bodyGeometry, bodyMaterial);
            body.castShadow = true;
            npcGroup.add(body);
            
            // Head
            const headGeometry = new THREE.SphereGeometry(0.3, 8, 8);
            const headMaterial = new THREE.MeshPhongMaterial({ color: 0xfad5a5 });
            const head = new THREE.Mesh(headGeometry, headMaterial);
            head.position.y = 0.7;
            head.castShadow = true;
            npcGroup.add(head);
            
            return npcGroup;
        }
        
        // Generate vehicles
        function generateVehicles() {
            // Player's car
            const playerCar = createVehicle('car', 0xe74c3c);
            playerCar.position.set(-20, 0.5, 0);
            playerCar.userData.type = 'car';
            playerCar.userData.occupied = false;
            playerCar.userData.speed = 0;
            playerCar.userData.maxSpeed = 0.3;
            playerCar.userData.acceleration = 0.02;
            scene.add(playerCar);
            gameState.vehicles.push(playerCar);
            
            // Police cars
            for (let i = 0; i < 5; i++) {
                const policeCar = createVehicle('police', 0x3498db);
                policeCar.position.set(
                    Math.random() * 800 - 400,
                    0.5,
                    Math.random() * 800 - 400
                );
                policeCar.userData.type = 'police';
                policeCar.userData.occupied = true;
                policeCar.userData.speed = 0.1 + Math.random() * 0.1;
                policeCar.userData.maxSpeed = 0.25;
                policeCar.userData.acceleration = 0.015;
                policeCar.userData.ai = {
                    targetX: Math.random() * 800 - 400,
                    targetZ: Math.random() * 800 - 400,
                    changeTargetTimer: Math.random() * 5
                };
                scene.add(policeCar);
                gameState.vehicles.push(policeCar);
            }
            
            // Ambulance
            const ambulance = createVehicle('ambulance', 0xffffff);
            ambulance.position.set(Math.random() * 800 - 400, 0.5, Math.random() * 800 - 400);
            ambulance.userData.type = 'ambulance';
            ambulance.userData.occupied = true;
            ambulance.userData.speed = 0.1;
            ambulance.userData.maxSpeed = 0.2;
            ambulance.userData.acceleration = 0.01;
            ambulance.userData.ai = {
                targetX: Math.random() * 800 - 400,
                targetZ: Math.random() * 800 - 400,
                changeTargetTimer: Math.random() * 5
            };
            scene.add(ambulance);
            gameState.vehicles.push(ambulance);
            
            // Bus
            const bus = createVehicle('bus', 0xf39c12);
            bus.position.set(Math.random() * 800 - 400, 1, Math.random() * 800 - 400);
            bus.scale.set(1.5, 1.5, 2);
            bus.userData.type = 'bus';
            bus.userData.occupied = true;
            bus.userData.speed = 0.05;
            bus.userData.maxSpeed = 0.15;
            bus.userData.acceleration = 0.005;
            bus.userData.ai = {
                targetX: Math.random() * 800 - 400,
                targetZ: Math.random() * 800 - 400,
                changeTargetTimer: Math.random() * 5
            };
            scene.add(bus);
            gameState.vehicles.push(bus);
            
            // Van
            const van = createVehicle('van', 0x2ecc71);
            van.position.set(Math.random() * 800 - 400, 0.5, Math.random() * 800 - 400);
            van.userData.type = 'van';
            van.userData.occupied = true;
            van.userData.speed = 0.1;
            van.userData.maxSpeed = 0.22;
            van.userData.acceleration = 0.012;
            van.userData.ai = {
                targetX: Math.random() * 800 - 400,
                targetZ: Math.random() * 800 - 400,
                changeTargetTimer: Math.random() * 5
            };
            scene.add(van);
            gameState.vehicles.push(van);
        }
        
        // Create a vehicle
        function createVehicle(type, color) {
            const vehicleGroup = new THREE.Group();
            
            // Car body
            const bodyGeometry = new THREE.BoxGeometry(2, 0.8, 4);
            const bodyMaterial = new THREE.MeshPhongMaterial({ color: color });
            const body = new THREE.Mesh(bodyGeometry, bodyMaterial);
            body.castShadow = true;
            body.receiveShadow = true;
            vehicleGroup.add(body);
            
            // Car top
            const topGeometry = new THREE.BoxGeometry(1.5, 0.6, 2.5);
            const topMaterial = new THREE.MeshPhongMaterial({ color: color });
            const top = new THREE.Mesh(topGeometry, topMaterial);
            top.position.y = 0.7;
            top.castShadow = true;
            vehicleGroup.add(top);
            
            // Windows
            const windowGeometry = new THREE.BoxGeometry(1.4, 0.4, 2.4);
            const windowMaterial = new THREE.MeshPhongMaterial({ 
                color: 0x1E90FF,
                transparent: true,
                opacity: 0.7
            });
            const windows = new THREE.Mesh(windowGeometry, windowMaterial);
            windows.position.y = 0.7;
            vehicleGroup.add(windows);
            
            // Wheels
            const wheelGeometry = new THREE.CylinderGeometry(0.3, 0.3, 0.2, 16);
            const wheelMaterial = new THREE.MeshPhongMaterial({ color: 0x222222 });
            
            // Front left wheel
            const wheelFL = new THREE.Mesh(wheelGeometry, wheelMaterial);
            wheelFL.rotation.z = Math.PI / 2;
            wheelFL.position.set(-1.2, -0.4, 1.2);
            wheelFL.castShadow = true;
            vehicleGroup.add(wheelFL);
            
            // Front right wheel
            const wheelFR = new THREE.Mesh(wheelGeometry, wheelMaterial);
            wheelFR.rotation.z = Math.PI / 2;
            wheelFR.position.set(1.2, -0.4, 1.2);
            wheelFR.castShadow = true;
            vehicleGroup.add(wheelFR);
            
            // Back left wheel
            const wheelBL = new THREE.Mesh(wheelGeometry, wheelMaterial);
            wheelBL.rotation.z = Math.PI / 2;
            wheelBL.position.set(-1.2, -0.4, -1.2);
            wheelBL.castShadow = true;
            vehicleGroup.add(wheelBL);
            
            // Back right wheel
            const wheelBR = new THREE.Mesh(wheelGeometry, wheelMaterial);
            wheelBR.rotation.z = Math.PI / 2;
            wheelBR.position.set(1.2, -0.4, -1.2);
            wheelBR.castShadow = true;
            vehicleGroup.add(wheelBR);
            
            // Special features based on type
            if (type === 'police') {
                // Police lights
                const lightGeometry = new THREE.BoxGeometry(0.2, 0.2, 0.2);
                const redLightMaterial = new THREE.MeshPhongMaterial({ color: 0xff0000, emissive: 0xff0000 });
                const blueLightMaterial = new THREE.MeshPhongMaterial({ color: 0x0000ff, emissive: 0x0000ff });
                
                const redLight = new THREE.Mesh(lightGeometry, redLightMaterial);
                redLight.position.set(0, 1.2, 1.5);
                vehicleGroup.add(redLight);
                
                const blueLight = new THREE.Mesh(lightGeometry, blueLightMaterial);
                blueLight.position.set(0, 1.2, -1.5);
                vehicleGroup.add(blueLight);
                
                // Add pulsing animation to lights
                vehicleGroup.userData.lights = { red: redLight, blue: blueLight };
            } else if (type === 'ambulance') {
                // Ambulance stripe
                const stripeGeometry = new THREE.BoxGeometry(2, 0.1, 4);
                const stripeMaterial = new THREE.MeshPhongMaterial({ color: 0xff0000 });
                const stripe = new THREE.Mesh(stripeGeometry, stripeMaterial);
                stripe.position.y = 0.4;
                vehicleGroup.add(stripe);
            }
            
            return vehicleGroup;
        }
        
        // Generate collectibles
        function generateCollectibles() {
            for (let i = 0; i < 20; i++) {
                const collectible = createCollectible();
                collectible.position.set(
                    Math.random() * 800 - 400,
                    0.5,
                    Math.random() * 800 - 400
                );
                collectible.userData.value = 100;
                collectible.userData.type = 'money';
                collectible.userData.rotationSpeed = 0.01;
                scene.add(collectible);
                gameState.collectibles.push(collectible);
            }
        }
        
        // Create a collectible
        function createCollectible() {
            const collectibleGroup = new THREE.Group();
            
            // Money bag
            const bagGeometry = new THREE.SphereGeometry(0.3, 8, 8);
            const bagMaterial = new THREE.MeshPhongMaterial({ 
                color: 0xf1c40f,
                emissive: 0xf1c40f,
                emissiveIntensity: 0.2
            });
            const bag = new THREE.Mesh(bagGeometry, bagMaterial);
            bag.castShadow = true;
            collectibleGroup.add(bag);
            
            // Create a simple dollar sign using basic shapes
            const dollarSignGroup = new THREE.Group();
            
            // Vertical line
            const lineGeometry = new THREE.BoxGeometry(0.05, 0.3, 0.05);
            const lineMaterial = new THREE.MeshPhongMaterial({ color: 0xffffff });
            const verticalLine = new THREE.Mesh(lineGeometry, lineMaterial);
            dollarSignGroup.add(verticalLine);
            
            // Top curve
            const topCurveGeometry = new THREE.TorusGeometry(0.1, 0.05, 8, 8, Math.PI);
            const topCurve = new THREE.Mesh(topCurveGeometry, lineMaterial);
            topCurve.rotation.x = Math.PI / 2;
            topCurve.position.y = 0.1;
            dollarSignGroup.add(topCurve);
            
            // Bottom curve
            const bottomCurveGeometry = new THREE.TorusGeometry(0.1, 0.05, 8, 8, Math.PI);
            const bottomCurve = new THREE.Mesh(bottomCurveGeometry, lineMaterial);
            bottomCurve.rotation.x = Math.PI / 2;
            bottomCurve.position.y = -0.1;
            dollarSignGroup.add(bottomCurve);
            
            dollarSignGroup.position.y = 0.1;
            collectibleGroup.add(dollarSignGroup);
            
            return collectibleGroup;
        }
        
        // Set up camera
        function setupCamera() {
            // Camera follows player
            camera.position.set(0, 5, 10);
            camera.lookAt(player.position);
        }
        
        // Update camera based on player position and mode
        function updateCamera(deltaTime) {
            if (gameState.player.inVehicle && gameState.player.vehicle) {
                // Camera follows vehicle
                const vehicle = gameState.player.vehicle;
                const vehicleDirection = new THREE.Vector3();
                vehicle.getWorldDirection(vehicleDirection);
                
                if (gameState.player.cameraMode === 'first') {
                    // First person view from vehicle
                    camera.position.copy(vehicle.position);
                    camera.position.y += 1.5;
                    camera.position.x += vehicleDirection.x * 1;
                    camera.position.z += vehicleDirection.z * 1;
                    camera.lookAt(
                        vehicle.position.x + vehicleDirection.x * 10,
                        vehicle.position.y,
                        vehicle.position.z + vehicleDirection.z * 10
                    );
                } else {
                    // Third person view of vehicle
                    const offset = new THREE.Vector3(0, 3, -8);
                    offset.applyQuaternion(vehicle.quaternion);
                    camera.position.copy(vehicle.position).add(offset);
                    camera.lookAt(vehicle.position);
                }
            } else {
                // Camera follows player on foot
                if (gameState.player.cameraMode === 'first') {
                    // First person view
                    camera.position.copy(player.position);
                    camera.position.y += 1.6;
                    
                    // Look in direction player is facing
                    const lookDirection = new THREE.Vector3(0, 0, -1);
                    lookDirection.applyQuaternion(player.quaternion);
                    camera.lookAt(
                        player.position.x + lookDirection.x * 10,
                        player.position.y + 1.6,
                        player.position.z + lookDirection.z * 10
                    );
                } else {
                    // Third person view
                    const cameraOffset = new THREE.Vector3(0, 3, -5);
                    cameraOffset.applyQuaternion(player.quaternion);
                    camera.position.copy(player.position).add(cameraOffset);
                    camera.lookAt(player.position);
                }
            }
        }
        
        // Toggle camera mode
        function toggleCamera() {
            gameState.player.cameraMode = gameState.player.cameraMode === 'first' ? 'third' : 'first';
            document.getElementById('cameraMode').textContent = 
                gameState.player.cameraMode === 'first' ? 'First Person' : 'Third Person';
            showNotification(`Camera: ${gameState.player.cameraMode === 'first' ? 'First Person' : 'Third Person'}`);
            
            // Show/hide player model based on camera mode
            if (playerModel) {
                playerModel.visible = gameState.player.cameraMode !== 'first' || !gameState.player.inVehicle;
            }
        }
        
        // Update renderer size
        function updateRendererSize() {
            const sidebar = document.querySelector('.sidebar');
            const header = document.querySelector('.header');
            const footer = document.querySelector('.footer');
            
            const width = window.innerWidth - (sidebar ? sidebar.offsetWidth : 0);
            const height = window.innerHeight - header.offsetHeight - footer.offsetHeight;
            
            renderer.setSize(width, height);
            camera.aspect = width / height;
            camera.updateProjectionMatrix();
        }
        
        // Set up event listeners
        function setupEventListeners() {
            // Keyboard events
            window.addEventListener('keydown', (e) => {
                keys[e.code] = true;
                
                // Prevent space bar from scrolling
                if (e.code === 'Space') {
                    e.preventDefault();
                    if (!gameState.player.inVehicle) {
                        // Jump
                        if (gameState.player.isOnGround) {
                            playerVelocity.y = jumpForce;
                            gameState.player.isOnGround = false;
                        }
                    } else {
                        // Shoot from vehicle
                        shoot();
                    }
                }
                
                // Reload weapon
                if (e.code === 'KeyR') {
                    gameState.player.ammo = 12;
                    updateUI();
                    showNotification('Weapon reloaded!');
                }
                
                // Toggle camera
                if (e.code === 'KeyC') {
                    toggleCamera();
                }
                
                // Enter/exit vehicle
                if (e.code === 'KeyE') {
                    if (gameState.player.inVehicle) {
                        exitVehicle();
                    } else {
                        tryEnterVehicle();
                    }
                }
            });
            
            window.addEventListener('keyup', (e) => {
                keys[e.code] = false;
            });
            
            // Mouse events for shooting
            renderer.domElement.addEventListener('mousedown', (e) => {
                if (e.button === 2) { // Right click
                    e.preventDefault();
                    shoot();
                }
            });
            
            // Prevent context menu
            renderer.domElement.addEventListener('contextmenu', (e) => {
                e.preventDefault();
            });
            
            // Mouse movement for looking around in first person
            renderer.domElement.addEventListener('mousemove', (e) => {
                if (document.pointerLockElement === renderer.domElement || 
                    document.mozPointerLockElement === renderer.domElement) {
                    
                    const movementX = e.movementX || e.mozMovementX || 0;
                    const movementY = e.movementY || e.mozMovementY || 0;
                    
                    if (gameState.player.cameraMode === 'first') {
                        // Update player/camera rotation based on mouse movement
                        const sensitivity = 0.002;
                        
                        // Horizontal rotation
                        player.rotation.y -= movementX * sensitivity;
                        
                        // Vertical rotation (limited)
                        if (camera.rotation.x - movementY * sensitivity > -1.5 && 
                            camera.rotation.x - movementY * sensitivity < 1.5) {
                            camera.rotation.x -= movementY * sensitivity;
                        }
                    }
                }
            });
            
            // Click to lock pointer for first person controls
            renderer.domElement.addEventListener('click', () => {
                if (gameState.player.cameraMode === 'first') {
                    renderer.domElement.requestPointerLock = 
                        renderer.domElement.requestPointerLock ||
                        renderer.domElement.mozRequestPointerLock;
                    renderer.domElement.requestPointerLock();
                }
            });
            
            // Window resize
            window.addEventListener('resize', () => {
                updateRendererSize();
            });
            
            // Reset game
            document.getElementById('resetGame').addEventListener('click', (e) => {
                e.preventDefault();
                if (confirm('Are you sure you want to reset the game?')) {
                    location.reload();
                }
            });
            
            // Fullscreen toggle
            document.getElementById('fullscreenToggle').addEventListener('click', (e) => {
                e.preventDefault();
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen().catch(err => {
                        console.error(`Error attempting to enable fullscreen: ${err.message}`);
                    });
                } else {
                    if (document.exitFullscreen) {
                        document.exitFullscreen();
                    }
                }
            });
            
            // Camera toggle button
            document.getElementById('cameraToggle').addEventListener('click', toggleCamera);
        }
        
        // Update player movement
        function updatePlayer(deltaTime) {
            const speed = keys['ShiftLeft'] || keys['ShiftRight'] ? 0.15 : 0.08;
            
            if (!gameState.player.inVehicle) {
                // Player on foot movement
                const direction = new THREE.Vector3();
                
                if (keys['KeyW'] || keys['ArrowUp']) {
                    direction.z -= 1;
                }
                if (keys['KeyS'] || keys['ArrowDown']) {
                    direction.z += 1;
                }
                if (keys['KeyA'] || keys['ArrowLeft']) {
                    direction.x -= 1;
                }
                if (keys['KeyD'] || keys['ArrowRight']) {
                    direction.x += 1;
                }
                
                // Normalize direction if moving diagonally
                if (direction.length() > 0) {
                    direction.normalize();
                    
                    // Apply player rotation for forward movement
                    const forward = new THREE.Vector3(0, 0, -1);
                    forward.applyQuaternion(player.quaternion);
                    
                    const right = new THREE.Vector3(1, 0, 0);
                    right.applyQuaternion(player.quaternion);
                    
                    // Calculate movement vector
                    const moveVector = new THREE.Vector3();
                    moveVector.addScaledVector(forward, -direction.z * speed);
                    moveVector.addScaledVector(right, direction.x * speed);
                    
                    // Update position
                    player.position.x += moveVector.x;
                    player.position.z += moveVector.z;
                    
                    // Rotate player to face movement direction
                    if (direction.z < 0) {
                        const targetRotation = Math.atan2(direction.x, -direction.z);
                        player.rotation.y = THREE.MathUtils.lerp(player.rotation.y, targetRotation, 0.2);
                    }
                }
                
                // Apply gravity
                playerVelocity.y += gravity * deltaTime;
                player.position.y += playerVelocity.y * deltaTime;
                
                // Ground collision
                if (player.position.y <= 1) {
                    player.position.y = 1;
                    playerVelocity.y = 0;
                    gameState.player.isOnGround = true;
                }
                
                // Update game state
                gameState.player.x = player.position.x;
                gameState.player.y = player.position.y;
                gameState.player.z = player.position.z;
            } else if (gameState.player.vehicle) {
                // Player in vehicle movement
                const vehicle = gameState.player.vehicle;
                let acceleration = 0;
                let steering = 0;
                
                if (keys['KeyW'] || keys['ArrowUp']) {
                    acceleration = vehicle.userData.acceleration;
                }
                if (keys['KeyS'] || keys['ArrowDown']) {
                    acceleration = -vehicle.userData.acceleration;
                }
                if (keys['KeyA'] || keys['ArrowLeft']) {
                    steering = 0.05;
                }
                if (keys['KeyD'] || keys['ArrowRight']) {
                    steering = -0.05;
                }
                
                // Apply acceleration
                vehicle.userData.speed += acceleration;
                
                // Limit speed
                if (vehicle.userData.speed > vehicle.userData.maxSpeed) {
                    vehicle.userData.speed = vehicle.userData.maxSpeed;
                }
                if (vehicle.userData.speed < -vehicle.userData.maxSpeed / 2) {
                    vehicle.userData.speed = -vehicle.userData.maxSpeed / 2;
                }
                
                // Apply steering
                vehicle.rotation.y += steering * (vehicle.userData.speed > 0 ? 1 : -1);
                
                // Apply friction
                if (!keys['KeyW'] && !keys['KeyS'] && !keys['ArrowUp'] && !keys['ArrowDown']) {
                    vehicle.userData.speed *= 0.98;
                }
                
                // Move vehicle
                const direction = new THREE.Vector3(0, 0, -1);
                direction.applyQuaternion(vehicle.quaternion);
                vehicle.position.addScaledVector(direction, vehicle.userData.speed);
                
                // Update player position
                player.position.copy(vehicle.position);
                player.position.y += 1;
            }
        }
        
        // Update NPCs
        function updateNPCs(deltaTime) {
            gameState.npcs.forEach((npc, index) => {
                // Update movement timer
                npc.userData.moveTimer -= deltaTime;
                if (npc.userData.moveTimer <= 0) {
                    npc.userData.direction = new THREE.Vector3(
                        Math.random() * 2 - 1,
                        0,
                        Math.random() * 2 - 1
                    ).normalize();
                    npc.userData.moveTimer = 1 + Math.random() * 4;
                }
                
                // Move NPC
                npc.position.addScaledVector(npc.userData.direction, npc.userData.speed * deltaTime);
                
                // Rotate NPC to face direction
                if (npc.userData.direction.length() > 0) {
                    const targetRotation = Math.atan2(npc.userData.direction.x, npc.userData.direction.z);
                    npc.rotation.y = THREE.MathUtils.lerp(npc.rotation.y, targetRotation, 0.1);
                }
                
                // Keep NPCs in bounds
                if (npc.position.x < -400) npc.position.x = -400;
                if (npc.position.x > 400) npc.position.x = 400;
                if (npc.position.z < -400) npc.position.z = -400;
                if (npc.position.z > 400) npc.position.z = 400;
            });
        }
        
        // Update vehicles
        function updateVehicles(deltaTime) {
            gameState.vehicles.forEach((vehicle, index) => {
                // Skip player's vehicle if player is driving it
                if (vehicle === gameState.player.vehicle) return;
                
                // AI for NPC vehicles
                if (vehicle.userData.ai) {
                    vehicle.userData.ai.changeTargetTimer -= deltaTime;
                    
                    // Change target periodically
                    if (vehicle.userData.ai.changeTargetTimer <= 0) {
                        vehicle.userData.ai.targetX = Math.random() * 800 - 400;
                        vehicle.userData.ai.targetZ = Math.random() * 800 - 400;
                        vehicle.userData.ai.changeTargetTimer = 3 + Math.random() * 5;
                    }
                    
                    // Calculate direction to target
                    const dx = vehicle.userData.ai.targetX - vehicle.position.x;
                    const dz = vehicle.userData.ai.targetZ - vehicle.position.z;
                    const distance = Math.sqrt(dx * dx + dz * dz);
                    
                    if (distance > 10) {
                        // Turn towards target
                        const targetRotation = Math.atan2(dx, dz);
                        const rotationDiff = targetRotation - vehicle.rotation.y;
                        
                        // Normalize angle difference
                        let normalizedDiff = rotationDiff;
                        while (normalizedDiff > Math.PI) normalizedDiff -= Math.PI * 2;
                        while (normalizedDiff < -Math.PI) normalizedDiff += Math.PI * 2;
                        
                        // Apply steering
                        vehicle.rotation.y += normalizedDiff * 0.05;
                        
                        // Accelerate
                        if (vehicle.userData.speed < vehicle.userData.maxSpeed) {
                            vehicle.userData.speed += vehicle.userData.acceleration;
                        }
                    } else {
                        // Slow down when close to target
                        vehicle.userData.speed *= 0.95;
                    }
                    
                    // Move vehicle
                    const direction = new THREE.Vector3(0, 0, -1);
                    direction.applyQuaternion(vehicle.quaternion);
                    vehicle.position.addScaledVector(direction, vehicle.userData.speed);
                }
                
                // Police AI - chase player if wanted level > 0
                if (vehicle.userData.type === 'police' && gameState.wantedLevel > 0) {
                    const dx = player.position.x - vehicle.position.x;
                    const dz = player.position.z - vehicle.position.z;
                    const distance = Math.sqrt(dx * dx + dz * dz);
                    
                    if (distance < 100) {
                        // Chase player
                        const targetRotation = Math.atan2(dx, dz);
                        vehicle.rotation.y = THREE.MathUtils.lerp(vehicle.rotation.y, targetRotation, 0.1);
                        
                        // Speed up when chasing
                        if (vehicle.userData.speed < vehicle.userData.maxSpeed * 1.5) {
                            vehicle.userData.speed += vehicle.userData.acceleration * 2;
                        }
                    }
                }
                
                // Animate police lights
                if (vehicle.userData.type === 'police' && vehicle.userData.lights) {
                    const time = Date.now() * 0.001;
                    vehicle.userData.lights.red.position.y = 1.2 + Math.sin(time * 10) * 0.1;
                    vehicle.userData.lights.blue.position.y = 1.2 + Math.cos(time * 10) * 0.1;
                }
            });
        }
        
        // Update collectibles
        function updateCollectibles(deltaTime) {
            gameState.collectibles.forEach((collectible, index) => {
                // Rotate collectible
                collectible.rotation.y += collectible.userData.rotationSpeed;
                
                // Bob up and down
                const time = Date.now() * 0.001;
                collectible.position.y = 0.5 + Math.sin(time + index) * 0.2;
                
                // Check collision with player
                const distance = player.position.distanceTo(collectible.position);
                if (distance < 2) {
                    // Collect
                    gameState.player.money += collectible.userData.value;
                    scene.remove(collectible);
                    gameState.collectibles.splice(index, 1);
                    
                    showNotification(`+$${collectible.userData.value}!`);
                    updateUI();
                    
                    // Create new collectible after delay
                    setTimeout(() => {
                        const newCollectible = createCollectible();
                        newCollectible.position.set(
                            Math.random() * 800 - 400,
                            0.5,
                            Math.random() * 800 - 400
                        );
                        newCollectible.userData.value = 100;
                        newCollectible.userData.type = 'money';
                        newCollectible.userData.rotationSpeed = 0.01;
                        scene.add(newCollectible);
                        gameState.collectibles.push(newCollectible);
                    }, 5000);
                }
            });
        }
        
        // Try to enter a vehicle
        function tryEnterVehicle() {
            for (const vehicle of gameState.vehicles) {
                const distance = player.position.distanceTo(vehicle.position);
                if (distance < 3) {
                    // Enter vehicle
                    gameState.player.inVehicle = true;
                    gameState.player.vehicle = vehicle;
                    gameState.player.vehicleType = vehicle.userData.type;
                    
                    // Position player in vehicle
                    player.position.copy(vehicle.position);
                    player.position.y += 1;
                    
                    // Hide player model when in vehicle (for first person)
                    playerModel.visible = gameState.player.cameraMode !== 'first';
                    
                    showNotification(`Entered ${vehicle.userData.type} vehicle!`);
                    updateUI();
                    return;
                }
            }
        }
        
        // Exit vehicle
        function exitVehicle() {
            if (!gameState.player.inVehicle || !gameState.player.vehicle) return;
            
            const vehicle = gameState.player.vehicle;
            
            // Position player next to vehicle
            const direction = new THREE.Vector3(1, 0, 0);
            direction.applyQuaternion(vehicle.quaternion);
            player.position.copy(vehicle.position);
            player.position.addScaledVector(direction, 3);
            player.position.y = 1;
            
            // Show player model
            playerModel.visible = true;
            
            // Update game state
            gameState.player.inVehicle = false;
            gameState.player.vehicle = null;
            gameState.player.vehicleType = null;
            
            showNotification('Exited vehicle!');
            updateUI();
        }
        
        // Shoot weapon
        function shoot() {
            if (gameState.player.ammo <= 0) return;
            
            gameState.player.ammo--;
            
            // Create bullet
            const bullet = createBullet();
            scene.add(bullet);
            gameState.bullets.push(bullet);
            
            // Increase wanted level
            if (gameState.wantedLevel < 5) {
                gameState.wantedLevel++;
                updateWantedLevel();
                showNotification(`Wanted level increased to ${gameState.wantedLevel}!`);
            }
            
            updateUI();
        }
        
        // Create a bullet
        function createBullet() {
            const bulletGeometry = new THREE.SphereGeometry(0.1, 8, 8);
            const bulletMaterial = new THREE.MeshPhongMaterial({ color: 0xf39c12 });
            const bullet = new THREE.Mesh(bulletGeometry, bulletMaterial);
            
            // Position bullet at player/weapon position
            if (gameState.player.inVehicle && gameState.player.vehicle) {
                bullet.position.copy(gameState.player.vehicle.position);
                bullet.position.y += 1;
            } else {
                bullet.position.copy(player.position);
                bullet.position.y += 1.6;
            }
            
            // Set bullet direction
            const direction = new THREE.Vector3(0, 0, -1);
            if (gameState.player.cameraMode === 'first') {
                // Use camera direction for first person
                camera.getWorldDirection(direction);
            } else {
                // Use player forward direction for third person
                direction.applyQuaternion(player.quaternion);
            }
            
            bullet.userData.velocity = direction.multiplyScalar(1);
            bullet.userData.life = 2; // seconds
            
            return bullet;
        }
        
        // Update bullets
        function updateBullets(deltaTime) {
            for (let i = gameState.bullets.length - 1; i >= 0; i--) {
                const bullet = gameState.bullets[i];
                
                // Move bullet
                bullet.position.addScaledVector(bullet.userData.velocity, deltaTime * 50);
                
                // Decrease life
                bullet.userData.life -= deltaTime;
                
                // Remove bullet if life ended or far away
                if (bullet.userData.life <= 0 || bullet.position.length() > 1000) {
                    scene.remove(bullet);
                    gameState.bullets.splice(i, 1);
                }
            }
        }
        
        // Update UI
        function updateUI() {
            document.getElementById('healthValue').textContent = `${Math.round(gameState.player.health)}%`;
            document.getElementById('healthBar').style.width = `${gameState.player.health}%`;
            document.getElementById('moneyValue').textContent = `$${gameState.player.money}`;
            document.getElementById('weaponValue').textContent = gameState.player.weapon.charAt(0).toUpperCase() + gameState.player.weapon.slice(1);
            document.getElementById('vehicleValue').textContent = gameState.player.inVehicle ? 
                `${gameState.player.vehicleType.charAt(0).toUpperCase() + gameState.player.vehicleType.slice(1)}` : 'On Foot';
            document.getElementById('policeValue').textContent = gameState.wantedLevel === 0 ? 'None' : `Level ${gameState.wantedLevel}`;
            document.getElementById('ammoCount').textContent = gameState.player.ammo;
            
            // Update health bar color
            const healthBar = document.getElementById('healthBar');
            if (gameState.player.health > 70) {
                healthBar.style.backgroundColor = '#2ecc71';
            } else if (gameState.player.health > 30) {
                healthBar.style.backgroundColor = '#f39c12';
            } else {
                healthBar.style.backgroundColor = '#e74c3c';
            }
        }
        
        // Update wanted level display
        function updateWantedLevel() {
            const wantedStars = document.getElementById('wantedStars');
            wantedStars.innerHTML = '';
            
            for (let i = 0; i < 5; i++) {
                const star = document.createElement('div');
                star.className = i < gameState.wantedLevel ? 'wanted-star' : 'wanted-star empty';
                star.innerHTML = '<i class="fas fa-star"></i>';
                wantedStars.appendChild(star);
            }
        }
        
        // Show notification
        function showNotification(text, duration = 2000) {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notificationText');
            
            notificationText.textContent = text;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, duration);
        }
        
        // Draw minimap
        function drawMiniMap() {
            const miniMap = document.getElementById('miniMap');
            const ctx = miniMap.getContext('2d');
            
            // Clear minimap
            ctx.fillStyle = '#2c3e50';
            ctx.fillRect(0, 0, miniMap.width, miniMap.height);
            
            // Draw player position
            const playerX = (player.position.x + 400) / 800 * miniMap.width;
            const playerY = (player.position.z + 400) / 800 * miniMap.height;
            
            ctx.fillStyle = gameState.player.inVehicle ? '#e74c3c' : '#ffffff';
            ctx.beginPath();
            ctx.arc(playerX, playerY, 4, 0, Math.PI * 2);
            ctx.fill();
            
            // Draw police cars
            gameState.vehicles.forEach(vehicle => {
                if (vehicle.userData.type === 'police') {
                    const vx = (vehicle.position.x + 400) / 800 * miniMap.width;
                    const vy = (vehicle.position.z + 400) / 800 * miniMap.height;
                    
                    ctx.fillStyle = '#3498db';
                    ctx.beginPath();
                    ctx.arc(vx, vy, 3, 0, Math.PI * 2);
                    ctx.fill();
                }
            });
            
            // Draw minimap border
            ctx.strokeStyle = '#3498db';
            ctx.lineWidth = 2;
            ctx.strokeRect(0, 0, miniMap.width, miniMap.height);
        }
        
        // Game loop
        function animate() {
            requestAnimationFrame(animate);
            
            const deltaTime = clock.getDelta();
            
            // Update game state
            updatePlayer(deltaTime);
            updateNPCs(deltaTime);
            updateVehicles(deltaTime);
            updateCollectibles(deltaTime);
            updateBullets(deltaTime);
            updateCamera(deltaTime);
            
            // Update minimap
            drawMiniMap();
            
            // Update game time
            gameState.gameTime += deltaTime;
            
            // Randomly decrease wanted level over time
            if (gameState.gameTime - gameState.lastWantedIncrease > 10 && gameState.wantedLevel > 0) {
                gameState.wantedLevel--;
                updateWantedLevel();
                gameState.lastWantedIncrease = gameState.gameTime;
                
                if (gameState.wantedLevel === 0) {
                    showNotification('Wanted level cleared!');
                }
            }
            
            // Render scene
            renderer.render(scene, camera);
        }
        
        // Initialize the game
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
